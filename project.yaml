version: '3.0'

expectations:
  population_size: 1000

actions:

  generate_study_pop_covdischarged:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covdischarged
    outputs:
      highly_sensitive:
        cohort: output/input_covdischarged.csv

  generate_study_pop_pneum2019:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_pneum2019
    outputs:
      highly_sensitive:
        cohort: output/input_pneum2019.csv

  generate_study_pop_flu2017_19:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_flu2017_19
    outputs:
      highly_sensitive:
        cohort: output/input_flu2017_19.csv

        
  generate_2019pool02:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool02
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool02.csv        

  generate_2019pool02_ALT:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019 --index-date-range "2019-02-01"
    outputs:
      highly_sensitive:
        cohort: output/input_2019_2019-02-01.csv        

  generate_2019pool03:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool03
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool03.csv        

  generate_2019pool04:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool04
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool04.csv        

  generate_2019pool05:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool05
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool05.csv        

  generate_2019pool06:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool06
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool06.csv        

  generate_2019pool07:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool07
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool07.csv        

  generate_2019pool08:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool08
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool08.csv        
           
  generate_2019pool09:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool09
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool09.csv        

  generate_2019pool10:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool10
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool10.csv        
      
  generate_2019pool11:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool11
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool11.csv        

  generate_2019pool12:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019pool12
    outputs:
      highly_sensitive:
        cohort: output/input_2019pool12.csv        
                   
  create_covid:
    run: stata-mp:latest analysis/cr_create_analysis_dataset.do COVID
    needs: [generate_study_pop_covdischarged]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_analysis_dataset_COVID.dta
      moderately_sensitive:
        log: analysis/output/cr_create_analysis_dataset_COVID.log

  create_pneum2019:
    run: stata-mp:latest analysis/cr_create_analysis_dataset.do PNEUM 
    needs: [generate_study_pop_pneum2019]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_analysis_dataset_PNEUM.dta
      moderately_sensitive:
        log: analysis/output/cr_create_analysis_dataset_PNEUM.log
 
  create_flu2017_19:
    run: stata-mp:latest analysis/cr_create_analysis_dataset.do FLU 
    needs: [generate_study_pop_flu2017_19]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_analysis_dataset_FLU.dta
      moderately_sensitive:
        log: analysis/output/cr_create_analysis_dataset_FLU.log

  create_2019pool02:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 02
    needs: [generate_2019pool02]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_02.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_02.log

  create_2019pool03:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 03
    needs: [generate_2019pool03]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_03.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_03.log

  create_2019pool04:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 04
    needs: [generate_2019pool04]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_04.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_04.log

  create_2019pool05:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 05
    needs: [generate_2019pool05]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_05.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_05.log

  create_2019pool06:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 06
    needs: [generate_2019pool06]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_06.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_06.log

  create_2019pool07:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 07
    needs: [generate_2019pool07]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_07.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_07.log

  create_2019pool08:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 08
    needs: [generate_2019pool08]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_08.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_08.log

  create_2019pool09:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 09
    needs: [generate_2019pool09]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_09.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_09.log

  create_2019pool10:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 10
    needs: [generate_2019pool10]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_10.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_10.log

  create_2019pool11:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 11
    needs: [generate_2019pool11]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_11.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_11.log

  create_2019pool12:
    run: stata-mp:latest analysis/cr_create_2019pool_data.do 12
    needs: [generate_2019pool12]
    outputs:
      highly_sensitive:
        cohort: analysis/cr_create_2019pool_data_12.dta
      moderately_sensitive:
        log: analysis/output/cr_create_2019pool_data_12.log


  getmatches2019:
    run: stata-mp:latest analysis/cr_getmatches2019.do
    needs:
      - create_covid
      - create_2019pool02
      - create_2019pool03
      - create_2019pool04
      - create_2019pool05
      - create_2019pool06
      - create_2019pool07
      - create_2019pool08
      - create_2019pool09
      - create_2019pool10
      - create_2019pool11
      - create_2019pool12
    outputs:
      highly_sensitive:
        cohort: analysis/cr_getmatches2019.dta
      moderately_sensitive:
        log: analysis/output/cr_getmatches2019.log

  appenddata:
    run: stata-mp:latest analysis/cr_append_process_data.do
    needs:
      - create_covid
      - create_pneum2019
      - create_flu2017_19
      - getmatches2019
    outputs:
      highly_sensitive:
        cohort: analysis/cr_append_process_data.dta
      moderately_sensitive:
        log: analysis/output/cr_append_process_data.log

  andescriptives_models:
    run: stata-mp:latest analysis/model_descriptives_models.do
    needs: 
      - generate_study_pop_covdischarged
      - appenddata
    outputs:
      moderately_sensitive:
        logs: analysis/output/*.log 
        tables: analysis/output/an_*.txt
        figures: analysis/output/an_cumulativeincidence*.svg
        timefig: analysis/output/an_desc*.svg
        models: analysis/output/models/an_cox*.ster

  anprocess_forestplots:
    run: stata-mp:latest analysis/model_forestplots.do
    needs: [andescriptives_models]
    outputs:
      moderately_sensitive:
        graphs: analysis/output/an_processout_*.svg 
      
  run_model:
    run: stata-mp:latest analysis/model.do
    needs: [generate_study_pop_covdischarged]
    outputs:
      moderately_sensitive:
        log: logs/model.log

